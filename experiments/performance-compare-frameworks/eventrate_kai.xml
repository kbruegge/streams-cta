<application>

    <property name="runtime" value="streams-runtime" />

    <stream id="data" class="streams.cta.io.LoopStream" limit="60000">

        <stream id="cta:data" class="streams.cta.io.ImageStream" url="classpath:/images.json.gz" />

    </stream>

    <service id="regressor" class="streams.cta.PredictionService"
             url="classpath:/test_regressor.pmml" />
    <service id="classifier" class="streams.cta.PredictionService"
             url="classpath:/test_classifier.pmml" />

    <queue id="passDataRate"/>

    <process id="processing" input="data">
        <streams.cta.SplitByTelescope key="@telescopes" />
        <ForEach key="@telescopes">
            <streams.cta.cleaning.TailCut />
            <streams.cta.features.Moments />
            <streams.cta.TelescopePredictions regressor="regressor"
                                              classifier="classifier"
                                              local="true"/>
        </ForEach>
        <streams.cta.MergeByTelescope key="@telescopes"/>
        <streams.cta.SummarizePredictions />
        <streams.cta.stereo.Stereo/>


        <!--Remove data from item which are not needed anymore. I only want to write the datarate to a csv file-->
        <RemoveKeys keys="*telescope*,*array*"/>

        <!--Only every 1000nth event will be put into the queue-->
        <streams.DataRate every="1000" logmemory="true"/>
        <Enqueue condition="%{data.@datarate} != null" queue="passDataRate"/>
    </process>

    <process id="datarate" input="passDataRate">
            <streams.cta.io.CSVWriter
                    url="file:../../data/measurements/performance-compare-frameworks/performance.csv"
                    keys="@datarate,@stream,@totalmemory,@freememory"/>

    </process>

</application>
