<application>

    <property name="runtime" value="streams-runtime" />
    <property name="outfile" value="../../data/measurements/performance-compare-frameworks/performance.csv" />

    <stream id="data" class="streams.cta.io.LoopStream" limit="10000">

        <stream id="cta:data" class="streams.cta.io.ImageStream" url="classpath:/images.json.gz" />

    </stream>

    <service id="regressor" class="streams.cta.PredictionService"
             url="classpath:/test_regressor.pmml" />
    <service id="classifier" class="streams.cta.PredictionService"
             url="classpath:/test_classifier.pmml" />

    <queue id="passDataRate"/>

    <process id="processing" input="data">
        <streams.cta.SplitByTelescope key="@telescopes" />
        <ForEach key="@telescopes">
            <streams.cta.cleaning.TailCut />
            <streams.cta.features.Moments />
            <streams.cta.TelescopePredictions regressor="regressor"
                                              classifier="classifier"
                                              local="true"/>
        </ForEach>
        <streams.cta.MergeByTelescope key="@telescopes"/>
        <streams.cta.SummarizePredictions />
        <streams.cta.stereo.Stereo/>
        <RemoveKeys keys="@datarate,@*memory,*telescope*" />
        <streams.DataRate every="1000" logmemory="true"/>
        <Enqueue condition="%{data.@datarate} != null" queue="passDataRate"/>
    </process>

    <process id="datarate" input="passDataRate">

        <If condition="%{data.@datarate} != null}" >
            <streams.cta.io.CSVWriter
                    url="file:${outfile}"
                    keys="@datarate,@stream,@totalmemory,@freememory"/>
        </If>
    </process>

</application>
